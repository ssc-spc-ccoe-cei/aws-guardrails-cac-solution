# Notes

## Setup Lambdas

The following lambda function (starting with aws\_ prefix) are used to prepare the base environment, including Audit Manager, S3, IAM and AWS Config resources setup.

## aws_auditmanager_resources_config_setup

- Hardcoded values ðŸ”¥

  ```py
  frameworks_data_string = zlib.decompress(base64.b64decode( "eJztXGtv2...")).decode("utf-8")
  ```

- `cfnresponse` class replaced with:

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info:

  - Score: 9.15/ 10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Some functions are too complex (>10 branches)
    - 12, 20, 18, 13 control statements
  - Unused function arguments

- Testing Status: SUCCESS âœ…

## aws_auditmanager_setup

- `cfnresponse` class replaced with:

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info:

  - Score: 9.03/ 10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Some functions are too complex
    - 11, 11, 12 control statements

- Testing Status: SUCCESS âœ…

## aws_buckets_setup

- Hardcoded values (defaults) ðŸ”¥

  ```py
  evidence_bucket_name = event["ResourceProperties"].get("EvidenceBucketName", "gc-evidence-%s", random_suffix)

  awsconfig_bucket_name = event["ResourceProperties"].get("AWSConfigBucketName", "gc-awsconfigconforms-%s", random_suffix)
  ```

- `cfnresponse` class replaced with:

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info:

  - Score: 8.78/ 10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - One function is too complex
    - 15 control statements
  - Catching too general exception of type `Exception`

- Testing Status: SUCCESS âœ…

Note: since both buckets are generated by the same lambda function, ensure to provide both when supplying existing ones as parameters, or leave empty so that both are generated with the same postfix.

## aws_config_setup

- No hardcoding âœ…

- `cfnresponse` class replaced with:

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info:

  - Score: 8.72/ 10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - One function is too complex
    - 11 control statements

- Testing Status: SUCCESS âœ…

## aws_generate_bucket_name

- Hardcoded values (defaults) ðŸ”¥

  ```py
  # evidenceBucketName
  response_data["EvidenceBucketName"] = f"gc-evidence-{random_suffix}"

  # AWSConfigBucketName
  response_data["AWSConfigBucketName"] = f"gc-awsconfigconforms-{random_suffix}"
  ```

- `cfnresponse` class replaced with:

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info

  - Score: 9.78/ 10 ðŸ’¡
    - Too many arguments (7/5) in send() function

- Testing Status: SUCCESS âœ…

### aws_lambda_permissions_setup

- Hardcoded values ðŸ”¥ --> Lambda Function Resource Map

```py
    lambda_functions = {
        f"{organization_name}gc01_check_iam_users_mfa": ["GC01CheckIAMUsersMFALambda"],
        f"{organization_name}gc01_check_root_mfa": ["GC01CheckRootAccountMFAEnabledLambda"],
        f"{organization_name}gc02_check_iam_password_policy": ["GC02CheckIAMPasswordPolicyLambda"],
        f"{organization_name}gc03_check_endpoint_access_config": ["GC03CheckEndpointAccessConfigLambda"],
        f"{organization_name}gc03_check_trusted_devices_admin_access": ["GC03CheckTrustedDevicesAdminAccessLambda"],
        f"{organization_name}gc04_check_enterprise_monitoring": ["GC04CheckEnterpriseMonitoringLambda"],
        f"{organization_name}gc05_check_data_location": ["GC05CheckDataLocationLambda"],
        f"{organization_name}gc06_check_encryption_at_rest_part1": ["GC06CheckEncryptionAtRestPart1Lambda"],
        f"{organization_name}gc06_check_encryption_at_rest_part2": ["GC06CheckEncryptionAtRestPart2Lambda"],
        f"{organization_name}gc07_check_certificate_authorities": ["GC07CheckCertificateAuthoritiesLambda"],
        f"{organization_name}gc07_check_cryptographic_algorithms": ["GC07CheckCryptographicAlgorithmsLambda"],
        f"{organization_name}gc07_check_encryption_in_transit": ["GC07CheckEncryptionInTransitLambda"],
        f"{organization_name}gc07_check_secure_network_transmission_policy": ["GC07CheckSecureNetworkTransmissionPolicyLambda"],
        f"{organization_name}gc08_check_cloud_deployment_guide": ["GC08CheckCloudDeploymentGuideLambda"],
        f"{organization_name}gc08_check_cloud_segmentation_design": ["GC08CheckCloudSegmentationDesignLambda"],
        f"{organization_name}gc08_check_target_network_architecture": ["GC08CheckTargetNetworkArchitectureLambda"],
        f"{organization_name}gc09_check_netsec_architecture": ["GC09CheckNetworkSecurityArchitectureDocumentLambda"],
        f"{organization_name}gc10_check_cyber_center_sensors": ["GC10CheckCyberCenterSensorsLambda"],
        f"{organization_name}gc10_confirmation_of_mou": ["GC10CheckSignedMOULambda"],
        f"{organization_name}gc11_check_monitoring_all_users": ["GC11CheckMonitoringAllUsersLambda"],
        f"{organization_name}gc11_check_monitoring_use_cases": ["GC11CheckMonitoringUseCasesLambda"],
        f"{organization_name}gc11_check_policy_event_logging": ["GC11CheckPolicyEventLoggingLambda"],
        f"{organization_name}gc11_check_security_contact": ["GC11CheckSecurityContactLambda"],
        f"{organization_name}gc11_check_timezone": ["GC11CheckTimezoneLambda"],
        f"{organization_name}gc11_check_trail_logging": ["GC11CheckTrailLoggingLambda"],
        f"{organization_name}gc12_check_marketplace": ["GC12CheckMarketplacesLambda"],
        f"{organization_name}gc13_emergency_account_alerts": ["GC13EmergencyAccountAlertsLambda"],
        f"{organization_name}gc13_emergency_account_management": ["GC13EmergencyAccountManagementLambda"],
        f"{organization_name}gc13_emergency_account_mgmt_approvals": ["GC13EmergencyAccountMgmtApprovalsLambda"],
        f"{organization_name}gc13_emergency_account_testing": ["GC13EmergencyAccountTestingLambda"],
    }
```

- `cfnresponse` class replaced with

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info:

  - Score: 8.60/ 10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - One function is too complex
    - 23 control statements

- Testing Status: SUCCESS âœ…

## aws_bucket_watcher

- No hardcoding âœ…
- No linting issues âœ…
- Linting info: 10/ 10 âœ…
- Testing Status: SUCCESS âœ…

## aws_compile_audit_report

- No hardcoding âœ…
- Linting info
  - Score 8.38/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - One function is too complex
    - 12 control statements
  - Unused arguments
  - Too many nested blocks
- Testing Status: SUCCESS âœ…

## aws_create_role

- No hardcoding âœ…
- `cfnresponse` class replaced with:

  ```py
  send(event, context, response_status, response_data, physical_resource_id=None, no_echo=False, reason=None):
  ```

- Linting info

  - Score 9.27/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - One function is too complex
    - 31 control statements
    - Too many local variables
    - Too many branches
    - Too many statements

- Testing Status: SUCCESS âœ…

## Guardrails Lambdas

The following lambdas (starting with gc(n)\_ prefix) are used as part of AWS Config Conformance Pack custom checks across the multi-account environment.

## gc01_check_attestation_letter

- No hardcoding âœ…
- Linting info
  - Score 8.80/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Global variables (from the main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc01_check_root_mfa

- No hardcoding âœ…
- Linting info
  - Score 9.04/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Global variables (from main handler method)
  - Two functions are too complex
- Check against the Management Account
- Testing Status: SUCCESS âœ…
  - Check against the Management Account


## gc02_check_iam_password_policy

- No hardcoding âœ…
- Linting info
  - Score 8.35/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Global variables (from main handler method)
  - Too many statements (61/50)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc02_check_iam_users_mfa

- No hardcoding âœ…
- Linting info
  - Score 8.94/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…
  - Note: evaluation not recorded in AWS Config when there are no IAM users

## gc04_check_enterprise_monitoring

- No hardcoding âœ…
- Linting info
  - Score 9.04/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Too many nested blocks
  - Global variables (from main handler method)
- Check against the Management Account
- Testing Status: SUCCESS âœ…

## gc05_check_data_location

- No hardcoding âœ…
- Linting info
  - Score 8.88/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Too many nested blocks
  - Too many branches
  - Too many statements
  - Global variables (from main handler method)
- Check against the Management Account
- Testing Status: SUCCESS âœ…

## gc06_check_encryption_at_rest_part1

- No hardcoding âœ…
- Linting info
  - Score 8.76/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Too many local variables
  - Too many nested blocks
  - Too many branches
  - Too many statements
  - Global variables (from main handler method)
- Check against the Management Account
- Testing Status: SUCCESS âœ…

## gc06_check_encryption_at_rest_part2

- No hardcoding âœ…
- Linting info
  - Score 8.46/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Too many local variables
  - Too many nested blocks
  - Too many branches
  - Too many statements
  - Global variables (from main handler method)
- Check against the Management Account
- Testing Status: SUCCESS âœ…

## gc07_check_encryption_in_transit

- No hardcoding âœ…
- Linting info
  - Score 8.52/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Too many local variables
  - Too many nested blocks
  - Too many branches
  - Too many statements
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc07_check_secure_network_transmission_policy

- No hardcoding âœ…
- Linting info
  - Score 8.90/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc08_check_target_network_architecture

- No hardcoding âœ…
- Linting info
  - Score 9.11/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc09_check_netsec_architecture

- No hardcoding âœ…
- Linting info
  - Score 8.87/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc10_confirmation_of_mou

- No hardcoding âœ…
- Linting info
  - Score 8.90/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc11_check_security_contact

- No hardcoding âœ…
- Linting info
  - Score 9.07/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing status: FAIL âŒ

```js
/* testing log */

[ERROR] ValueError: Unexpected error: An error occurred (AccessDeniedException) when calling the GetAlternateContact operation: User: arn:aws:sts::061849379246:assumed-role/gc-default_assessment_role/LCCFedGovgc11_check_security_contact is not authorized to perform: account:GetAlternateContact on resource: arn:aws:account::061849379246:account with an explicit deny

Traceback (most recent call last):
Â Â File "/var/task/app.py", line 188, in lambda_handler
Â Â Â Â if check_security_contact():
Â Â File "/var/task/app.py", line 91, in check_security_contact
Â Â Â Â raise ValueError(f"Unexpected error: {err}") from err
```

## gc11_check_trail_logging

- No hardcoding âœ…
- Linting info
  - Score 8.82/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Unnecessary "else" after "raise"
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## gc12_check_marketplace

- No hardcoding âœ…
- Linting info
  - Score 8.92/10 ðŸ’¡
  - Line Length >100 (mainly loggers)
  - Unused arguments
  - Global variables (from main handler method)
- Check against the Audit Account
- Testing Status: SUCCESS âœ…

## Others

### Conformance Pack

- Hardcoded values (defaults) ðŸ”¥

```yaml
Parameters:
  EnterpriseMonitoringIAMTrustedPrincipal:
    Default: "arn:aws:iam::939755092653:root"
    Type: String
```

### Audit Account Pre Requisites Part N

- Hardcoded values (defaults) ðŸ”¥

```yaml
LambdaPermissionsSetup:
  UpdateVariable: QVdTb21lCg8
```
