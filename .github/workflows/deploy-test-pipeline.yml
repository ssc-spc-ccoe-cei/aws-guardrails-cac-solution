name: Deploy to Test

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  AWS_REGION: ca-central-1
  ENVIRONMENT: test

jobs:
  set-env-vars:
    runs-on: ubuntu-latest
    outputs:
      aws_role_arn: ${{ steps.set-vars.outputs.aws_role_arn }}
      config_file_content: ${{ steps.set-vars.outputs.config_file_content }}
    steps:
      - id: set-vars
        run: |
          if [ "${{ env.ENVIRONMENT }}" == "test" ]; then
            echo "::set-output name=aws_role_arn::${{ secrets.TEST_AWS_ROLE_ARN }}"
            echo "::set-output name=config_file_content::${{ secrets.TEST_CONFIG_FILE_CONTENT }}"
          elif [ "${{ env.ENVIRONMENT }}" == "prod" ]; then
            echo "::set-output name=aws_role_arn::${{ secrets.PROD_AWS_ROLE_ARN }}"
            echo "::set-output name=config_file_content::${{ secrets.PROD_CONFIG_FILE_CONTENT }}"
          fi

  deployToTest:
    needs: set-env-vars
    permissions:
      id-token: write
      contents: read
    uses: ssc-spc-ccoe-cei/aws-guardrails-cac-solution/.github/workflows/deploy.yml@singhgss-patch-1
    with:
      environment: test
      aws-region: ca-central-1
      deploy-version: 1.0.0
    secrets:
      AWS_ROLE_ARN: ${{ needs.set-env-vars.outputs.aws_role_arn }}
      CONFIG_FILE_CONTENT: ${{ needs.set-env-vars.outputs.config_file_content }}


